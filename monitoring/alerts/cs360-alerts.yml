# CS360 Hub - Alertas do Prometheus
groups:
  # ===== APPLICATION ALERTS =====
  - name: cs360-application
    rules:
      # High Error Rate
      - alert: CS360HighErrorRate
        expr: rate(cs360_http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
          team: engineering
          service: cs360-hub
        annotations:
          summary: "CS360 Hub high error rate detected"
          description: "CS360 Hub is experiencing {{ $value | humanizePercentage }} error rate for the last 5 minutes"
          runbook_url: "https://runbooks.cs360hub.com/high-error-rate"

      # Application Down
      - alert: CS360ApplicationDown
        expr: up{job="cs360-hub"} == 0
        for: 1m
        labels:
          severity: critical
          team: engineering
          service: cs360-hub
        annotations:
          summary: "CS360 Hub application is down"
          description: "CS360 Hub application has been down for more than 1 minute"
          runbook_url: "https://runbooks.cs360hub.com/application-down"

      # High Response Time
      - alert: CS360HighResponseTime
        expr: histogram_quantile(0.95, rate(cs360_http_request_duration_seconds_bucket[5m])) > 2
        for: 10m
        labels:
          severity: warning
          team: engineering
          service: cs360-hub
        annotations:
          summary: "CS360 Hub high response time"
          description: "95th percentile response time is {{ $value }}s for the last 10 minutes"

      # Low Success Rate
      - alert: CS360LowSuccessRate
        expr: rate(cs360_http_requests_total{status=~"2.."}[5m]) / rate(cs360_http_requests_total[5m]) < 0.95
        for: 5m
        labels:
          severity: warning
          team: engineering
          service: cs360-hub
        annotations:
          summary: "CS360 Hub low success rate"
          description: "Success rate is {{ $value | humanizePercentage }} for the last 5 minutes"

      # Database Connection Issues
      - alert: CS360DatabaseConnectionIssues
        expr: cs360_database_connections_failed_total > 10
        for: 2m
        labels:
          severity: critical
          team: engineering
          service: database
        annotations:
          summary: "CS360 Hub database connection failures"
          description: "{{ $value }} database connection failures in the last 2 minutes"

  # ===== INFRASTRUCTURE ALERTS =====
  - name: cs360-infrastructure
    rules:
      # High CPU Usage
      - alert: CS360HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value }}% on instance {{ $labels.instance }}"

      # High Memory Usage
      - alert: CS360HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.85
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value | humanizePercentage }} on instance {{ $labels.instance }}"

      # High Disk Usage
      - alert: CS360HighDiskUsage
        expr: (node_filesystem_size_bytes{fstype!~"tmpfs|fuse.lxcfs"} - node_filesystem_avail_bytes) / node_filesystem_size_bytes > 0.85
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "High disk usage on {{ $labels.instance }}"
          description: "Disk usage is {{ $value | humanizePercentage }} on instance {{ $labels.instance }}, mountpoint {{ $labels.mountpoint }}"

      # Node Down
      - alert: CS360NodeDown
        expr: up{job="node-exporter"} == 0
        for: 1m
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: "Node {{ $labels.instance }} is down"
          description: "Node {{ $labels.instance }} has been down for more than 1 minute"

  # ===== DOCKER/CONTAINER ALERTS =====
  - name: cs360-containers
    rules:
      # Container Down
      - alert: CS360ContainerDown
        expr: absent(container_last_seen{name=~"cs360.*"})
        for: 1m
        labels:
          severity: critical
          team: engineering
        annotations:
          summary: "CS360 container {{ $labels.name }} is down"
          description: "Container {{ $labels.name }} has been down for more than 1 minute"

      # High Container Memory Usage
      - alert: CS360ContainerHighMemory
        expr: container_memory_usage_bytes{name=~"cs360.*"} / container_spec_memory_limit_bytes > 0.8
        for: 5m
        labels:
          severity: warning
          team: engineering
        annotations:
          summary: "Container {{ $labels.name }} high memory usage"
          description: "Container {{ $labels.name }} memory usage is {{ $value | humanizePercentage }}"

      # Container Restart Loop
      - alert: CS360ContainerRestartLoop
        expr: increase(container_restarts_total{name=~"cs360.*"}[1h]) > 3
        for: 0m
        labels:
          severity: warning
          team: engineering
        annotations:
          summary: "Container {{ $labels.name }} restarting frequently"
          description: "Container {{ $labels.name }} has restarted {{ $value }} times in the last hour"

  # ===== NGINX/LOAD BALANCER ALERTS =====
  - name: cs360-nginx
    rules:
      # High 4xx Rate
      - alert: CS360HighClient4xxRate
        expr: rate(nginx_http_requests_total{status=~"4.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          team: engineering
        annotations:
          summary: "High 4xx error rate on Nginx"
          description: "4xx error rate is {{ $value }} requests/second for the last 5 minutes"

      # High 5xx Rate
      - alert: CS360HighServer5xxRate
        expr: rate(nginx_http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
          team: engineering
        annotations:
          summary: "High 5xx error rate on Nginx"
          description: "5xx error rate is {{ $value }} requests/second for the last 2 minutes"

  # ===== SSL/TLS ALERTS =====
  - name: cs360-ssl
    rules:
      # SSL Certificate Expiring
      - alert: CS360SSLCertExpiringSoon
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 7
        for: 0m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "SSL certificate expiring soon for {{ $labels.instance }}"
          description: "SSL certificate for {{ $labels.instance }} expires in {{ $value | humanizeDuration }}"

      # SSL Certificate Expired
      - alert: CS360SSLCertExpired
        expr: probe_ssl_earliest_cert_expiry - time() <= 0
        for: 0m
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: "SSL certificate expired for {{ $labels.instance }}"
          description: "SSL certificate for {{ $labels.instance }} has expired"

  # ===== BUSINESS METRICS ALERTS =====
  - name: cs360-business
    rules:
      # Low User Registrations
      - alert: CS360LowUserRegistrations
        expr: increase(cs360_user_registrations_total[1h]) < 5
        for: 0m
        labels:
          severity: warning
          team: product
        annotations:
          summary: "Low user registration rate"
          description: "Only {{ $value }} new user registrations in the last hour"

      # High Churn Rate
      - alert: CS360HighChurnRate
        expr: cs360_user_churn_rate > 0.1
        for: 1h
        labels:
          severity: warning
          team: product
        annotations:
          summary: "High user churn rate detected"
          description: "User churn rate is {{ $value | humanizePercentage }} for the last hour"

      # Payment Failures
      - alert: CS360PaymentFailures
        expr: increase(cs360_payment_failures_total[5m]) > 3
        for: 0m
        labels:
          severity: critical
          team: finance
        annotations:
          summary: "Multiple payment failures detected"
          description: "{{ $value }} payment failures in the last 5 minutes"

  # ===== SECURITY ALERTS =====
  - name: cs360-security
    rules:
      # Suspicious Login Attempts
      - alert: CS360SuspiciousLoginAttempts
        expr: increase(cs360_failed_login_attempts_total[5m]) > 50
        for: 0m
        labels:
          severity: warning
          team: security
        annotations:
          summary: "High number of failed login attempts"
          description: "{{ $value }} failed login attempts in the last 5 minutes"

      # DDoS Attack Detected
      - alert: CS360PossibleDDoSAttack
        expr: rate(nginx_http_requests_total[1m]) > 1000
        for: 2m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Possible DDoS attack detected"
          description: "Request rate is {{ $value }} requests/second, which may indicate a DDoS attack"

